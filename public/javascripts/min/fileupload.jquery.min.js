/*! fileupload 2013-10-03 */
define(["jquery","jqueryUI"],function(a){"use strict";a.widget("FU.fileupload",{options:{fieldName:"",errorClass:"",serverErrorMsg:"",fileExtnErrMsg:"File type is not support. It should be any of the following type [gif, png , jpg , pdf].",maxLimitErrMsg:"Total file size for images cannot exceed 5 MB.",loadingMsg:"Please wait, please are loading file(s) ..... ",isAjax:!1,upload_url:"/upload",remove_url:"/remove"},_init:function(){this._isFormDataSupproted(),a("input[type=file]").length>0&&!this.options.isAjax&&(this.options.fieldName=a(this.element).parents("form").find("input[type=file]").attr("name"),a("input[type=file]").remove()),this.options.isAjax?(this._prepareUI(),this._decorateButton(),this._addListeners(),this._styleElements()):(this._createElements(),this._styleElements(),a("body").append(this.elements.form),this._addListeners(),this._updatePosition(),this._decorateButton())},_prepareUI:function(){this.elements={},this.elements.uploadbutton=this.element,this.elements.form=this.elements.uploadbutton.parents("form"),this.elements.fileinput=this.elements.form.find('input[type="file"]'),this.elements.mainblock=this.elements.uploadbutton.parents(".fileupload"),this.elements.filecontainer=a("<ul> </ul>").addClass("file-container").css("padding","0"),this.elements.progress=a("<span></span>").html(this.options.loadingMsg).addClass("progress"),this.elements.uploaderror=a("<div></div>").html(this.options.maxLimitErrMsg).addClass("error").hide(),this.elements.mainblock.append(this.elements.progress),this.elements.mainblock.append(this.elements.uploaderror),this.elements.mainblock.append(this.elements.filecontainer)},_createElements:function(){this.elements={},this.elements.form=this._createForm(),this.elements.frame=this.elements.form.find("iframe"),this.elements.fileinput=this.elements.form.find("input[type=file]"),this.elements.uploadbutton=this.element,this.elements.mainblock=this.elements.uploadbutton.parents(".fileupload"),this.elements.filecontainer=a("<ul> </ul>").addClass("file-container").css("padding","0"),this.elements.progress=a("<span>Please wait, please are loading file(s) ..... </span>").addClass("progress"),this.elements.uploaderror=a("<div>Total file size for images cannot exceed 5 MB.</div>").addClass("error").hide(),this.elements.mainblock.append(this.elements.progress),this.elements.mainblock.append(this.elements.uploaderror),this.elements.mainblock.append(this.elements.filecontainer)},_styleElements:function(){this.elements.progress.css({background:'url("images/ajax-loader.gif") no-repeat 0 0',display:"block",height:"20px",margin:"10px 0",padding:"0 20px"}).hide(),this.elements.filecontainer.find("li").css({padding:"0","list-style":"none"}),this.elements.uploaderror.css({background:'url("images/error.png") no-repeat 0 0',padding:"0 0 0 30px",margin:"10px 0"})},_createForm:function(){var b=this,c=a('<form method="post" style="left:-9999px;position:absolute;"/>'),d=a('<input size="1" type="file" name="uploadfile" multiple style="z-index:9999;">'),e=a('<input type="hidden" name="_eventId_UploadDoc" value="Upload file"/>'),f=a('<iframe style="visibility: hidden;" name="UploadFrame_'+b.options.fieldName+'"></iframe>');return d.attr("id","uf_"+this.element.attr("id")),c.attr("id","FileUploadForm_"+this.element.attr("id")),c.attr({enctype:"multipart/form-data",target:f.attr("name"),action:this.options.upload_url}).append(d).append(e).append(f),c},_loadAjax:function(){var a=new FormData(this.elements.form.get(0));return a.append("uploadfile",this.options.fileinput),a},_isFormDataSupproted:function(){this.options.isAjax=void 0===window.FormData?!1:!0},_decorateButton:function(){this.elements.fileinput.width(this.elements.uploadbutton.width()).height(this.elements.uploadbutton.css("height")).css({opacity:"0","font-size":"9px",cursor:"pointer","z-index":"9999",position:"relative"}),this.elements.uploadbutton.css({cursor:"default",position:"relative",left:-this.elements.uploadbutton.width()})},_updatePosition:function(){this.elements.fileinput.offset({left:this.element.offset().left,top:this.element.offset().top})},_addListeners:function(){var a=this;a.elements.fileinput.on("change",function(b){a._upload(b,this)}),this.options.isAjax||a.elements.frame.on("load",a.elements.frame,function(){a.loadFiles(this)}),a.elements.filecontainer.on("click",".f-remove",function(b){a.removeFile(b)}),a.elements.uploadbutton.on("click",function(a){a.preventDefault()})},_upload:function(b,c){var d,e=this;if(e.isIE()){if(d=a(c).val().split(".").pop().toLowerCase(),-1==a.inArray(d,["gif","png","jpg","pdf"]))return this.elements.uploaderror.html(this.options.fileExtnErrMsg).show(),this._updatePosition(),!1}else{for(var f=c.files.length,g=0,h=4194304,i=0;f>i;i++){if(d=c.files[i].name.split(".").pop().toLowerCase(),-1==a.inArray(d,["gif","png","jpg","pdf"]))return this.elements.uploaderror.html(this.options.fileExtnErrMsg).show(),this._updatePosition(),!1;g+=c.files[i].size}if(g>h)return this.elements.uploaderror.html(this.options.maxLimitErrMsg).show(),this._updatePosition(),!1}this.elements.uploaderror.hide(),this.elements.progress.show(),this.options.isAjax?a.ajax({url:this.options.upload_url,type:"POST",data:this._loadAjax(),processData:!1,contentType:!1,success:function(a){e.showResponse(a)}}):this.elements.form.submit()},loadFiles:function(b){var c=this;c.elements.progress.removeClass("spinner").hide(),a(b).contents().find(".file-details").each(function(){var b=a.trim(a(this).html()),d=a("<li> </li>"),e=a("<span> </span>"),f=c._generateRemoveBlock();d.css({"max-width":"300px",position:"relative"}),e.attr("data-filename",b).html(b).appendTo(d),d.append(f),c.elements.filecontainer.prepend(d),a(this).remove()}),this.elements.filecontainer.find("li").css({padding:"5px 0 5px 30px","list-style":"none",background:'url("images/ok-icon.png") no-repeat left 5px'}),c.element.removeClass("hidden"),c._updatePosition(),c._refreshContainerAfterUpload(),c.elements.fileinput.val("")},removeFile:function(b){b.preventDefault();var c=b.target,d=this;a(c).parent("span").addClass("remove-spinner"),a.post(this.options.remove_url,{_eventId_RemoveDoc:"remove",filename:a(c).parent().siblings("span").data("filename")},function(b){b.status&&(a(c).parents("li").remove(),d._updatePosition())},"json").fail(function(){})},_generateRemoveBlock:function(){var b=a("<div> </div>");return a("<span> </span>").addClass("f-remove").css({background:'url("images/delete.png") no-repeat right center',display:"block","float":"right",height:"100%",width:"16px",cursor:"pointer"}).appendTo(b),b.css({position:"absolute",width:"100%",height:"100%","z-index":"2","background-color":"#f1f1f1",opacity:"0",top:"0","margin-left":"-10px","padding-right":"10px"})},_refreshContainerAfterUpload:function(){this.elements.filecontainer.find("li div").hover(function(){a(this).css("opacity","0.6")},function(){a(this).css("opacity","0")})},showResponse:function(b){var c=this,d=null;d=b instanceof a?b:a(b),a(d).each(function(){var b=a.trim(a(this).html()),d=a("<li> </li>"),e=a("<span> </span>"),f=c._generateRemoveBlock();d.css({"max-width":"300px",position:"relative"}),e.attr("data-filename",b).html(b).appendTo(d),d.append(f),c.elements.filecontainer.prepend(d),a(this).remove()}),this.elements.filecontainer.find("li").css({padding:"5px 0 5px 30px","list-style":"none",background:'url("images/ok-icon.png") no-repeat left 5px'}),c.element.removeClass("hidden"),c._updatePosition(),c._refreshContainerAfterUpload(),c.elements.fileinput.val(""),c.elements.progress.removeClass("spinner").hide()},isIE:function(){return window.userAgent.indexOf("MSIE")>0}})});